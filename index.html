<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Data Collector</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="Point data collector based on CartoDB">
	<meta name="author" content="">
	
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />
	<link rel="stylesheet" href="http://leaflet.github.io/Leaflet.draw/leaflet.draw.css" />

	<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">	
	<link rel="stylesheet" href="assets/uikit-2.23.0/css/uikit.css">	
	<link rel="stylesheet" href="assets/easy-button/easy-button.css">	

	
	<style>

		body {
			padding: 0;
			margin: 0;
		}

		html,
		body,
		#map {
			height: 100%;
			width: 100%;
		}

		p {
			font-size: 15px;
			line-height: 25px;
		}

		h1 {
			line-height: 60px;
			margin-top: 0px;
			margin-bottom: 0px;
			font-weight: lighter;
		}

		#wrapper {
			width: 750px;
		}

		#form {
			margin-top: 5px;
			font-size: 12px;
			text-align: left;
			line-height: 16px;
			width:375px;
			float: left;
		}

		#header {
			margin-top: 0px;
			margin-bottom: 0px;
		}

		#credits p {
			margin-top: 5px;
			font-size: 12px;
			text-align: right;
			line-height: 16px;
		}	
	</style>
	
</head>
<body>

	<div id="map"></div>

	<div id="dialog" title="Point Information">     
		<form>
			<fieldset style="border: none;">
				<ul style="list-style-type: none; padding-left: 0px">
					<li><label for="username">Your Name</label></li>
					<li><input type="text" name="username" id="username" placeholder="Enter your name" class="text ui-widget-content ui-corner-all"></li>
					<li><label for="description">About this Point</label></li>
					<li><input type="text" name="description" id="description" placeholder="Description for this point" class="text ui-widget-content ui-corner-all"></li>
				</ul>
				<input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
			</fieldset>
		</form>
	</div>



    <div id="form-modal" class="uk-modal">
      <div class="uk-modal-dialog">
        <a class="uk-modal-close uk-close"></a>
        <div class="uk-modal-header">
          <h3>Hydrant Information</h3>
        </div>
        <form id="hydrant-form" class="uk-form uk-form-horizontal" autocomplete="off">
          <div id="tags">
            <div class="uk-form-row uk-hidden">
              <label class="uk-form-label" for="osm-id">OSM ID</label>
              <div class="uk-form-controls">
                <input type="text" id="osm-id" name="osm-id" class="uk-width-1-1">
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="type">Type</label>
              <div class="uk-form-controls">
                <input type="text" autocapitalize="none" name="fire_hydrant:type" id="type" list="type-list" data-list-value-completion="true" class="uk-width-1-1">
                  <datalist id="type-list">
                    <option value="underground">
                    <option value="pillar">
                    <option value="wall">
                    <option value="pond">
                  </datalist>
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="position">Position</label>
              <div class="uk-form-controls">
                <input type="text" autocapitalize="none" name="fire_hydrant:position" id="position" list="position-list" data-list-value-completion="true" class="uk-width-1-1">
                  <datalist id="position-list">
                    <option value="lane">
                    <option value="parking_lot">
                    <option value="sidewalk">
                    <option value="green">
                  </datalist>
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="source">Water Source</label>
              <div class="uk-form-controls">
                <input type="text" autocapitalize="none" name="fire_hydrant:water_source" id="source" list="source-list" data-list-value-completion="true" class="uk-width-1-1">
                  <datalist id="source-list">
                    <option value="main">
                    <option value="pond">
                    <option value="stream">
                  </datalist>
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="in_service">In Service</label>
              <div class="uk-form-controls">
                <input type="text" autocapitalize="none" name="in_service" id="in_service" list="in_service-list" data-list-value-completion="true" class="uk-width-1-1">
                  <datalist id="in_service-list">
                    <option value="yes">
                    <option value="no">
                  </datalist>
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="colour">Color</label>
              <div class="uk-form-controls">
                <input type="text" autocapitalize="none" autocomplete="on" name="colour" id="colour" class="uk-width-1-1" placeholder="dominant color">
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="name">Name</label>
              <div class="uk-form-controls">
                <input type="text" name="name" id="name" class="uk-width-1-1" placeholder="hydrant name or id">
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="diameter">Diameter</label>
              <div class="uk-form-controls">
                <input type="number" autocapitalize="none" name="fire_hydrant:diameter" id="diameter" class="uk-width-1-1" placeholder="of main feeding hydrant">
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="pressure">Pressure</label>
              <div class="uk-form-controls">
                <input type="number" autocapitalize="none" name="fire_hydrant:pressure" id="pressure" class="uk-width-1-1" placeholder="pressure or suction for dry hydrants">
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="count">Count</label>
              <div class="uk-form-controls">
                <input type="number" autocapitalize="none" name="fire_hydrant:count" id="count" class="uk-width-1-1" placeholder="if more than 1 hydrant">
              </div>
            </div>
            <div class="uk-form-row">
              <label class="uk-form-label" for="note">Note</label>
              <div class="uk-form-controls">
                <input type="text" name="note" id="note" class="uk-width-1-1" placeholder="additional information">
              </div>
            </div>
            <div class="uk-form-row uk-hidden">
              <label class="uk-form-label" for="latitude">Latitude</label>
              <div class="uk-form-controls">
                <input type="text" name="latitude" id="latitude" class="uk-width-1-1">
              </div>
            </div>
            <div class="uk-form-row uk-hidden">
              <label class="uk-form-label" for="longitude">Longitude</label>
              <div class="uk-form-controls">
                <input type="text" name="longitude" id="longitude" class="uk-width-1-1">
              </div>
            </div>
          </div>
        </form>
        <hr>
        <form class="uk-form uk-form-horizontal">
          <div class="uk-form-row">
            <label class="uk-form-label" for="changeset-comment">OSM Changeset Comment</label>
            <div class="uk-form-controls">
              <textarea id="changeset-comment" autocomplete="on" rows="3" placeholder="describe your changes" class="uk-width-1-1"></textarea>
            </div>
          </div>
        </form>
        <p>
          <div class="uk-panel uk-panel-box uk-panel-box-secondary uk-text-muted uk-text-small">The changes you upload as <span id="user"></span> will be visible on all maps that use OpenStreetMap data. OpenStreetMapÂ® is open data, licensed under the <a href="http://opendatacommons.org/licenses/odbl/">Open Data Commons Open Database License</a> (ODbL) by the <a href="http://osmfoundation.org/">OpenStreetMap Foundation</a> (OSMF).</div>
        </p>
        <div class="uk-modal-footer">
          <div class="uk-grid">
              <div class="uk-width-1-2">
                <button id="edit-location-btn" type="button" class="uk-button uk-button-success">Edit location</button>
              </div>
              <div class="uk-width-1-2 uk-text-right">
                <button id="cancel-btn" type="button" class="uk-button">Cancel</button>
                <button id="save-btn" type="button" class="uk-button uk-button-primary">Save</button>
              </div>
          </div>
        </div>
      </div>
    </div>



	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.js"></script>

	<script src="http://leaflet.github.io/Leaflet.draw/leaflet.draw.js"></script>	
	<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<script src="assets/uikit-2.23.0/js/uikit.js"></script>
	<script src="assets/easy-button/easy-button.js"></script>

	<script>


		



    // Create Leaflet map object
    var map = L.map('map',{ center: [42.381899, -71.122499], zoom: 13});

    // Add Tile Layer basemap
    L.tileLayer('http://a{s}.acetate.geoiq.com/tiles/acetate-hillshading/{z}/{x}/{y}.png', {
    	attribution: '&copy;2012 Esri & Stamen, Data from OSM and Natural Earth',
    	subdomains: '0123',
    	minZoom: 2,
    	maxZoom: 18
    }).addTo(map);



L.easyButton('<img src="">', function(){
   UIkit.modal("#form-modal").show();
}).addTo(map);





    // Declare Variables
    // Create Global Variable to hold CartoDB points
    var cartoDBPoints = null;

    // Set your CartoDB Username
    var cartoDBUsername = "hast";

    // Write SQL Selection Query to be Used on CartoDB Table
    // Name of table is 'data_collector'
    var sqlQuery = "SELECT * FROM data_collector";

    // Create variable for Leaflet.draw features
    var drawnItems = new L.FeatureGroup();

    // Get CartoDB selection as GeoJSON and Add to Map
    function getGeoJSON(){
    	$.getJSON("https://"+cartoDBUsername+".cartodb.com/api/v2/sql?format=GeoJSON&q="+sqlQuery, function(data) {
    		cartoDBPoints = L.geoJson(data,{
    			pointToLayer: function(feature,latlng){
    				var marker = L.marker(latlng);
    				marker.bindPopup('<p>' + feature.properties.description + '<br /><em>Submitted by </em>' + feature.properties.name + '</p>');
    				return marker;
    			}
    		}).addTo(map);
    	});
    };

    // Run showAll function automatically when document loads
    $( document ).ready(function() {
    	getGeoJSON();
    });

    var drawControl = new L.Control.Draw({
    	draw : {
    		polygon : false,
    		polyline : false,
    		rectangle : false,
    		circle : false
    	},
    	edit : false,
    	remove: false
    });

    map.addControl(drawControl);
    
    map.on('draw:created', function (e) {
    	var layer = e.layer;

    	map.addLayer(drawnItems);
    	drawnItems.addLayer(layer);

    	dialog.dialog( "open" );
    });

    var submitToProxy = function(q){
      $.post("php/callProxy.php", { //Put path to your callProxy.php file here
      	qurl:q,
      	cache: false,
      	timeStamp: new Date().getTime()
      }, function(data) {
      	console.log(data);
      	refreshLayer();
      });
    };

    dialog = $( "#dialog" ).dialog({
    	autoOpen: false,
    	height: 300,
    	width: 350,
    	modal: true,
    	position: {
    		my: "center center",
    		at: "center center",
    		of: "#map"
    	},
    	buttons: {
    		"Add to Database": setData,
    		Cancel: function() {
    			dialog.dialog("close");
    			map.removeLayer(drawnItems);
    		}
    	},
    	close: function() {
    		form[ 0 ].reset();
    		console.log("Dialog closed");
    	}
    });

    form = dialog.find( "form" ).on( "submit", function( event ) {
    	event.preventDefault();
    	setData();
    });

    function setData() {
    	var enteredUsername = username.value;
    	var enteredDescription = description.value;
    	drawnItems.eachLayer(function (layer) {
    		var sql = "INSERT INTO data_collector (the_geom, description, name, latitude, longitude) VALUES (ST_SetSRID(ST_GeomFromGeoJSON('";
    			var a = layer.getLatLng();
    			console.log(a);
    			var sql2 ='{"type":"Point","coordinates":[' + a.lng + "," + a.lat + "]}'),4326),'" + enteredDescription + "','" + enteredUsername + "','" + a.lat + "','" + a.lng +"')";
    	var pURL = sql+sql2;
    	console.log(pURL);
    	submitToProxy(pURL);
    	console.log("Feature has been submitted to the Proxy");
    });
    	map.removeLayer(drawnItems);
    	drawnItems = new L.FeatureGroup();
    	console.log("drawnItems has been cleared");
    	dialog.dialog("close");
    };

    function refreshLayer() {
    	if (map.hasLayer(cartoDBPoints)) {
    		map.removeLayer(cartoDBPoints);
    	};
    	getGeoJSON();
    };
  </script>

  <!-- add LiveReload function -->
  <script>
  	document.write('<script src="http://' + (location.host || 'localhost')
  		.split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')
  </script>
</body>
</html>